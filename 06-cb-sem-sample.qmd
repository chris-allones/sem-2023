---
title: "Covariance Based Structural Equation Modelling (CB-SEM)"
---

```{r}
#| echo: false

knitr::opts_chunk$set(comment = "",
                      message = FALSE,
                      warning = FALSE
                      )

```


## Sample study

- Journal article: Young people's perceived service quality and environmental
performance of hybrid electric bus.
- Author: Zial Haque and Tehjeeb Noor
- [DOI Link](https://doi.org/10.1016/j.tbs.2020.03.003)
- Download the dataset [here](https://ars.els-cdn.com/content/image/1-s2.0-S2214367X19302492-mmc1.xlsx).


<div style="padding-bottom:56.25%; position:relative; display:block; width: 100%">
  <iframe width="100%" height="100%"
    src="https://www.sciencedirect.com/science/article/pii/S2214367X19302492"
    frameborder="0" allowfullscreen="" style="position:absolute; top:0; left: 0">
  </iframe>
</div>


## Libraries

```{r}
# Library
library(tidyverse)
library(readxl)
library(janitor)
library(lavaan)
library(psych)
library(MVN)
library(semTools)
```


## Data

```{r}
## data
case_data <- read_excel("00_data/e_bus_customer_satisfaction.xlsx") %>% 
 clean_names()

case_data_items <- case_data %>%
 select(bt1:bt7, bd1:bd4, emp1:emp5, cs1:cs3, ep1:ep4, ls1:ls5)
```


## Exploratory factor analysis

### Scree plot

```{r}
## Scree plot using parallel analysis
fa.parallel(case_data_items, fa = "fa")
```


### Factor extraction

```{r}
## Factor loading
bus_fa <- fa(r = case_data_items,
             nfactors = 6,
             rotate = "varimax")

print(bus_fa$loadings, sort = TRUE, cutoff = 0.4)
```


## Confirmatory factor analysis

### Specifying the measurement model

```{r}
## Specifying CFA model
cfa_model <- "tangible =~ bt1 + bt2 + bt4 + bt5 + bt6 + bt7
              drivers_quality =~ bd1 + bd2 + bd3 + bd4
              empathy =~ emp1 + emp2 + emp3 + emp4 + emp5
              env_perf =~ ep1 + ep2 + ep3 + ep4
              customer_sat =~ cs1 + cs2 + cs3
              life_sat =~ ls1 + ls2 + ls3 + ls4 + ls5"

```


### Fitting the model

```{r}
## Fitting CFA model
cfa_fit <- cfa(model = cfa_model, 
               data = case_data_items, 
               estimator = "MLR")

## Summary results
cfa_fit %>% summary(standardized = TRUE,
                     fit.measures = TRUE)
```


### Relibility and validity tests

```{r}
## Reliability and validity 
reliability(cfa_fit) %>% round(2)

```


## Structural equation modelling

### Specifying structural model

```{r}
## Specifying structural model
ebus_model <- "tangible =~ bt1 + bt2 + bt4 + bt5 + bt6 + bt7
              drivers_quality =~ bd1 + bd2 + bd3 + bd4
              empathy =~ emp1 + emp2 + emp3 + emp4 + emp5
              env_perf =~ ep1 + ep2 + ep3 + ep4
              customer_sat =~ cs1 + cs2 + cs3
              life_sat =~ ls1 + ls2 + ls3 + ls4 + ls5
              
              # structural model
              customer_sat ~ tangible + drivers_quality + empathy + env_perf
              life_sat ~ customer_sat"
```


### Fitting the structural model

```{r}
## Fitting structural model
ebus_fit <- sem(model = ebus_model,
                data = case_data,
                estimator = "MLR")

## Summary results
ebus_fit %>% summary(standardized = TRUE,
                     fit.measures = TRUE,
                     rsq = TRUE)
```


### Estimating indirect effects


#### Specifying model with indirect effects

```{r}
### SEM model with mediation
ebus_model_ie <- "tangible =~ bt1 + bt2 + bt4 + bt5 + bt6 + bt7
              drivers_quality =~ bd1 + bd2 + bd3 + bd4
              empathy =~ emp1 + emp2 + emp3 + emp4 + emp5
              env_perf =~ ep1 + ep2 + ep3 + ep4
              customer_sat =~ cs1 + cs2 + cs3
              life_sat =~ ls1 + ls2 + ls3 + ls4 + ls5
              
              # structural model
              customer_sat ~ a*tangible + b*drivers_quality + c*empathy + d*env_perf
              life_sat ~ e*customer_sat
             
              # indirect effects
              ie_tangible := a*e
              ie_drivers_qual := b*e
              ie_empathy := c*e
              ie_en_perf := d*e"

```


#### Fitting the model with indirect effects

```{r}
### Fitting structural model with mediation 
ebus_fit_ie <- sem(model = ebus_model_ie,
                   data = case_data,
                   estimator = "MLR")

### Summary results
ebus_fit_ie %>% summary(standardized = TRUE,
                        fit.measures = TRUE,
                        rsq = TRUE)

```

